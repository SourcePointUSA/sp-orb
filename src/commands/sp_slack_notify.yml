description: >
  This command is a wrapper around the slack orb to provide more custom messaging
parameters:
  header:
    type: string
  event:
    description: |
      In what event should this message send? Options: ["fail", "pass", "always"]
    type: enum
    enum: ["fail", "pass", "always"]
    default: "always"
  link_to_workflow:
    description: |
      should the action button link directly to workflow
    type: boolean
    default: false
  branch_pattern:
    description: |
      A comma separated list of regex matchable branch names.
      Notifications will only be sent if sent from a job from these branches.
      By default ".+" will be used to match all branches.
      Pattern must match the full string, no partial matches.
    type: string
    default: ".+"
steps:
  - run:
      name: Export parameters
      command: |
        echo 'export SLACK_MESSAGE_HEADER="<< parameters.header >>"' >> $BASH_ENV
        echo 'export SLACK_GIT_URL="<< pipeline.project.git_url >>"' >> $BASH_ENV
        if [ "<< parameters.link_to_workflow >>" = "true" ]
        then
          echo 'export CIRCLE_CI_ACTION_LINK="${SLACK_PARAM_CIRCLECI_HOST}/workflow-run/${CIRCLE_WORKFLOW_ID}"' >> $BASH_ENV
        else
          echo 'export CIRCLE_CI_ACTION_LINK="${CIRCLE_BUILD_URL}"' >> $BASH_ENV
        fi
  - slack/notify:
      event: <<parameters.event>>
      branch_pattern: <<parameters.branch_pattern>>
      custom: |
        {
          "text": "$SLACK_MESSAGE_HEADER",
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "$SLACK_MESSAGE_HEADER",
                "emoji": true
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*Project*: $CIRCLE_PROJECT_REPONAME"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Branch*: $CIRCLE_BRANCH"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Author*: $CIRCLE_USERNAME"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Build Number*: $CIRCLE_BUILD_NUM"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Commit*: <${SLACK_GIT_URL}/commit/${CIRCLE_SHA1}|${CIRCLE_SHA1:0:7}>"
                }
              ],
              "accessory": {
                "type": "image",
                "image_url": "https://assets.brandfolder.com/otz5mn-bw4j2w-6jzqo8/original/circle-logo-badge-black.png",
                "alt_text": "CircleCI logo"
              }
            },
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "View in CircleCI"
                  },
                  "url": "${CIRCLE_CI_ACTION_LINK}"
                }
              ]
            }
          ]
        }
