description: >
  This command will deploy a previously built docker image to k8s
parameters:
  resource_name:
    type: string
  resource-file-path:
    type: string
  namespace:
    type: string
  cluster_name:
    description: |
      Which environment to deploy? Options: ["pl-prod", "pl-stage"]
    type: enum
    enum: ["pl-prod", "pl-stage"]
    default: "pl-stage"
  git_url:
    description: |
      the url to the project in git, try using pipeline.project.git_url
    type: string
steps:
  - run:
      environment:
        PARAM_CLUSTER_NAME: <<parameters.cluster_name>>
        PARAM_GIT_SHA1: ${CIRCLE_SHA1:0:7}
      name: Export Slack environmental parameters for << parameters.cluster_name >> cluster
      command: <<include(scripts/k8s_export_parameters.sh)>>
  - checkout
  - aws-eks/update-kubeconfig-with-authenticator:
      install-aws-cli: true
      install-kubectl: true
      kubectl-version: v1.23.6
      aws-region: ${KUBE_AWS_REGION}
      cluster-name: << parameters.cluster_name >>
  - run:
      name: Test EKS connection
      command: |
        kubectl get deployments -n << parameters.namespace >>
  - kubernetes/create-or-update-resource:
      get-rollout-status: true
      resource-file-path: << parameters.resource-file-path >>
      resource-name: << parameters.resource_name >>
      namespace: << parameters.namespace >>
      show-kubectl-command: true
      envsubst: true
  - sp_slack_notify:
      branch_pattern: main
      event: fail
      header: "Deployment to << parameters.cluster_name >> failed :red_circle:"
      git_url: << parameters.git_url >>
  - sp_slack_notify:
      branch_pattern: main
      event: pass
      header: "Deployment to << parameters.cluster_name >> succeeded :white_check_mark:"
      git_url: << parameters.git_url >>
