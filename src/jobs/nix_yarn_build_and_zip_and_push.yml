description: >
  Perform standard yarn build and test routine

executor: sp_standard_executor

parameters:
  cache_name:
    description: |
      the unique name of the cache
    type: string
    default: yarn-env-cache
  ssh_key_fingerprint:
    description: |
      optional ssh key to be added
    type: string
    default: ""
  project_name:
    description: |
      The name of the project to be used in the notification template.
    type: string
  project_git_url:
    description: |
      the url to the project in git, try using pipeline.project.git_url
    type: string
  zip_filename_prefix:
    description: |
      the prefix of the zip file
    type: string
  zip_input_folder:
    description: |
      the source folder to zip up
    type: string
  s3_destination_bucket:
    description: |
      the s3 destination to push to
    type: string
steps:
  - when:
      condition: << parameters.ssh_key_fingerprint >>
      steps:
        - add_ssh_keys:
            fingerprints:
              - "<< parameters.ssh_key_fingerprint >>"
  - checkout
  - yarn_restore_cache:
      cache_name: << parameters.cache_name >>
  - nix_build_environment
  - nix_yarn_install
  - nix_yarn_build_code
  - nix_zip_file:
      zip_filename: << parameters.zip_filename_prefix >>-${CIRCLE_BUILD_NUM}-${CIRCLE_SHA1:0:7}.zip
      zip_input_folder: << parameters.zip_input_folder >>
  - s3_push:
      file_to_upload: << parameters.zip_filename_prefix >>-${CIRCLE_BUILD_NUM}-${CIRCLE_SHA1:0:7}.zip
      s3_destination_bucket: << parameters.s3_destination_bucket >>
      project_name: << parameters.project_name >>
      project_git_url: << parameters.project_git_url >>
  - yarn_save_cache:
      cache_name: << parameters.cache_name >>
  - slack_notify_build_and_test_failure:
      branch_pattern: main
      project_name: << parameters.project_name >>
      project_git_url: << parameters.project_git_url >>
